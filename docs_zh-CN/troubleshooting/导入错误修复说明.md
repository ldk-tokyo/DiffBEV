# 导入错误修复说明

## 问题描述

运行 baseline 实验时遇到导入错误：
```
ImportError: cannot import name 'get_dist_info' from 'mmengine.runner'
```

## 原因分析

在 **mmengine 0.10+** 版本中，`get_dist_info` 和 `init_dist` 函数的位置发生了变化：
- **旧位置**：`mmengine.runner`（或 `mmcv.runner`）
- **新位置**：`mmengine.dist`

当前环境使用的是 **mmengine 0.10.7**，这些函数位于 `mmengine.dist` 模块中。

## 修复方案

已修复以下文件中的导入语句，使其兼容不同版本的 mmengine 和 mmcv：

### 修复的文件

1. **`tools/train.py`**
   - 修复 `get_dist_info` 和 `init_dist` 的导入

2. **`tools/test.py`**
   - 修复 `get_dist_info` 和 `init_dist` 的导入
   - 修复 `MMDataParallel` 和 `MMDistributedDataParallel` 的导入

3. **`mmseg/datasets/builder.py`**
   - 修复 `get_dist_info` 的导入
   - 修复 `collate` 的导入

4. **`mmseg/apis/test.py`**
   - 修复 `get_dist_info` 的导入

5. **`mmseg/apis/inference.py`**
   - 修复 `collate` 和 `scatter` 的导入

6. **`mmseg/apis/train.py`**
   - 修复 `MMDataParallel` 和 `MMDistributedDataParallel` 的导入

### 导入策略

采用兼容性导入策略，按优先级尝试：

#### 1. get_dist_info 和 init_dist

```python
# 尝试从 mmengine.dist 导入（mmengine 0.10+）
try:
    from mmengine.dist import get_dist_info, init_dist
except ImportError:
    try:
        # 回退到 mmcv.runner（mmcv 1.x）
        from mmcv.runner import get_dist_info, init_dist
    except ImportError:
        # 最后尝试 mmengine.runner（某些版本）
        from mmengine.runner import get_dist_info, init_dist
```

#### 2. collate 和 scatter

```python
# 尝试从 mmcv.parallel 导入（mmcv 1.x）
try:
    from mmcv.parallel import collate, scatter
except ImportError:
    try:
        from mmengine.parallel import collate, scatter
    except ImportError:
        # 使用 PyTorch 原生实现作为回退
        from torch.utils.data.dataloader import default_collate as collate
        # scatter 的简单实现...
```

#### 3. MMDataParallel 和 MMDistributedDataParallel

```python
# 尝试从 mmcv.parallel 导入（mmcv 1.x）
try:
    from mmcv.parallel import MMDataParallel, MMDistributedDataParallel
except ImportError:
    try:
        from mmengine.parallel import MMDataParallel, MMDistributedDataParallel
    except ImportError:
        # 使用 PyTorch 原生实现作为回退
        from torch.nn.parallel import DataParallel as MMDataParallel
        from torch.nn.parallel import DistributedDataParallel as MMDistributedDataParallel
```

## 验证

所有文件已通过语法检查：
- ✅ `tools/train.py`
- ✅ `tools/test.py`
- ✅ `mmseg/datasets/builder.py`
- ✅ `mmseg/apis/test.py`
- ✅ `mmseg/apis/inference.py`
- ✅ `mmseg/apis/train.py`

## 问题2：mmengine.parallel 模块不存在

### 问题描述

```
ModuleNotFoundError: No module named 'mmengine.parallel'
```

### 原因分析

在 **mmengine 0.10.7** 中，`mmengine.parallel` 模块不存在。以下函数/类需要从 `mmcv.parallel` 导入：
- `collate` 和 `scatter`
- `MMDataParallel` 和 `MMDistributedDataParallel`

当前环境使用的是 **mmcv 1.3.15**，这些函数/类位于 `mmcv.parallel` 模块中。

## 使用方法

现在可以正常运行 baseline 实验：

```bash
# 1. 激活环境
micromamba activate diffbev

# 2. 运行baseline实验
bash run_baseline_nuscenes.sh
```

## 兼容性

修复后的代码兼容：
- ✅ **mmengine 0.10+**：从 `mmengine.dist` 导入 `get_dist_info` 和 `init_dist`
- ✅ **mmcv 1.x**：从 `mmcv.runner` 导入 `get_dist_info` 和 `init_dist`
- ✅ **mmcv 1.x**：从 `mmcv.parallel` 导入 `collate`、`scatter`、`MMDataParallel`、`MMDistributedDataParallel`
- ✅ **其他版本**：自动回退到可用位置或使用 PyTorch 原生实现

## 相关文档

- **mmcv升级指南.md**：MMCV 升级相关说明
- **版本兼容性说明.md**：版本兼容性详细说明
