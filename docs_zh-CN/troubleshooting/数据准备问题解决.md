# 数据准备问题解决指南

## 已解决的问题

### 1. ✅ yacs 模块缺失
**问题**: `ModuleNotFoundError: No module named 'yacs'`

**解决**:
```bash
pip install yacs
```

### 2. ✅ 路径大小写问题
**问题**: 配置期望 `nuscenes`（小写），实际路径是 `nuScenes`（大写S）

**解决**: 创建符号链接
```bash
cd /media/ldk950413/data0
ln -sf nuScenes nuscenes
```

### 3. ✅ 环境变量配置
**问题**: 脚本需要 `DATA_ROOT` 和 `PROCESSED_ROOT` 环境变量

**解决**: 在运行脚本前设置
```bash
export DATA_ROOT=/media/ldk950413/data0
export PROCESSED_ROOT=/media/ldk950413/data0/nuScenes
```

## 当前问题

### ⚠️ 地图文件缺失

**错误信息**:
```
FileNotFoundError: [Errno 2] No such file or directory: 
'/media/ldk950413/data0/nuscenes/maps/expansion/boston-seaport.json'
```

**原因**: nuScenes 数据集需要下载地图文件（maps）

**解决方案**:

1. **检查 maps 目录**:
   ```bash
   ls -la /media/ldk950413/data0/nuScenes/maps/
   ```

2. **下载地图文件**:
   - 从 nuScenes 官网下载 `v1.0-trainval_map_expansion.tgz`
   - 解压到 `/media/ldk950413/data0/nuScenes/maps/` 目录

3. **地图文件结构应该是**:
   ```
   /media/ldk950413/data0/nuScenes/maps/
   ├── expansion/
   │   ├── boston-seaport.json
   │   ├── singapore-hollandvillage.json
   │   ├── singapore-onenorth.json
   │   └── singapore-queenstown.json
   └── ...
   ```

## 完整的数据准备步骤

### 步骤1: 安装依赖

```bash
cd /media/ldk950413/data0/DiffBEV
micromamba activate diffbev
pip install yacs shapely python-dotenv nuscenes-devkit
```

### 步骤2: 创建符号链接（如果还没有）

```bash
cd /media/ldk950413/data0
ln -sf nuScenes nuscenes
```

### 步骤3: 下载地图文件（如果缺失）

从 nuScenes 官网下载并解压地图文件到正确位置。

### 步骤4: 运行数据准备脚本

```bash
cd /media/ldk950413/data0/DiffBEV
bash prepare_nuscenes_bev_data.sh
```

或者手动运行：

```bash
cd /media/ldk950413/data0/DiffBEV/mono-semantic-maps
export DATA_ROOT=/media/ldk950413/data0
export PROCESSED_ROOT=/media/ldk950413/data0/nuScenes
python scripts/make_nuscenes_labels.py
```

## 验证数据准备

数据准备完成后，应该生成：

```
/media/ldk950413/data0/nuScenes/map-labels-v1.2/
├── <token1>.png
├── <token2>.png
└── ...
```

这些文件需要进一步组织到 `img_dir` 和 `ann_bev_dir` 目录中。

## 下一步

数据准备完成后，需要：
1. 将生成的标注文件组织到 `ann_bev_dir/train` 和 `ann_bev_dir/val`
2. 提取对应的图像文件到 `img_dir/train` 和 `img_dir/val`
3. 然后才能开始训练
