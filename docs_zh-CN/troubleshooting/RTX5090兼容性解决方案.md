# RTX 5090 GPU兼容性解决方案

## 问题说明

RTX 5090是新一代Blackwell架构GPU，发布于2024年，通常需要：
- **CUDA 12.x** 或更高版本
- **PyTorch 2.x** 才能获得完整支持
- **较新的驱动**（>550版本）

但本项目基于：
- **PyTorch 1.9.1** (2021年)
- **mmcv-full 1.3.x**（仅支持PyTorch 1.x）
- **CUDA 11.1**

这是一个硬件与软件版本不匹配的问题。

## 解决方案

### 方案1：使用环境变量允许PyTorch 2.x（推荐尝试）

如果RTX 5090必须使用PyTorch 2.x，可以设置环境变量来允许继续执行：

```bash
# 1. 激活环境
micromamba activate diffbev

# 2. 设置环境变量允许PyTorch 2.x
export DIFFBEV_ALLOW_PYTORCH2=1

# 3. 运行训练
python tools/train.py configs/pyva/pyva_swin_nuscenes.py --work-dir work_dirs/test
```

**注意**：
- ⚠️ 这会绕过PyTorch版本检查
- ⚠️ mmcv-full 1.3.x可能与PyTorch 2.x不兼容
- ⚠️ 可能遇到运行时错误，需要相应的代码修改

### 方案2：检查PyTorch 1.x是否真的不支持RTX 5090

首先验证PyTorch 1.x是否能在RTX 5090上运行：

```bash
micromamba activate diffbev

# 检查CUDA是否可用
python -c "import torch; print(f'CUDA可用: {torch.cuda.is_available()}'); print(f'GPU: {torch.cuda.get_device_name(0) if torch.cuda.is_available() else \"N/A\"}')"

# 如果CUDA可用，尝试创建一个简单的tensor
python -c "import torch; x = torch.randn(2, 3).cuda(); print('GPU计算成功！')"
```

如果PyTorch 1.9.1可以在RTX 5090上运行，则不需要使用PyTorch 2.x。

### 方案3：使用兼容的mmcv版本（需要测试）

尝试安装支持PyTorch 2.x的mmcv版本：

```bash
# 注意：这需要修改代码中的API调用
pip uninstall mmcv-full
pip install mmcv==2.0.0  # 或更新的版本

# 但需要检查代码是否需要修改
```

**风险**：需要大量代码修改，可能破坏现有功能。

### 方案4：使用Docker容器（如果支持）

如果系统支持容器，可以使用特定版本的CUDA容器来隔离环境。

## 当前代码的处理

代码已经更新以支持RTX 5090的情况：

1. **自动检测新GPU**：代码会自动检测RTX 5090等新架构GPU
2. **环境变量控制**：通过`DIFFBEV_ALLOW_PYTORCH2=1`允许PyTorch 2.x
3. **友好提示**：检测到新GPU时会给出明确的使用说明

## 使用步骤

### 步骤1：验证GPU和PyTorch

```bash
micromamba activate diffbev

# 检查GPU信息
python -c "import torch; print(torch.cuda.is_available()); print(torch.cuda.get_device_name(0) if torch.cuda.is_available() else 'No GPU')"
```

### 步骤2：尝试PyTorch 1.x（如果可能）

```bash
# 检查PyTorch 1.9.1是否能在RTX 5090上工作
python -c "import torch; x = torch.randn(2, 3).cuda(); print('PyTorch 1.x可以工作！')"
```

如果成功，继续使用PyTorch 1.9.1。

### 步骤3：如果必须使用PyTorch 2.x

```bash
# 设置环境变量
export DIFFBEV_ALLOW_PYTORCH2=1

# 运行训练（会显示警告，但允许继续）
python tools/train.py configs/pyva/pyva_swin_nuscenes.py --work-dir work_dirs/test
```

### 步骤4：处理可能出现的错误

如果遇到mmcv相关的错误，可能需要：

1. **检查错误信息**：记录具体的错误
2. **尝试修复**：根据错误信息修改代码
3. **或降级mmcv**：如果可能，尝试找到兼容的mmcv版本

## 常见错误及处理

### 错误1：mmcv导入失败

```
ImportError: cannot import name 'XXX' from 'mmcv'
```

**可能原因**：mmcv 1.3.x和PyTorch 2.x不兼容

**解决方案**：
- 尝试安装兼容的mmcv版本
- 或修改代码以使用不同的API

### 错误2：CUDA操作失败

```
RuntimeError: CUDA error: no kernel image is available for execution
```

**可能原因**：PyTorch版本不支持GPU架构

**解决方案**：
- 使用支持RTX 5090的PyTorch版本
- 检查CUDA驱动版本

### 错误3：API不兼容

```
AttributeError: module 'torch' has no attribute 'XXX'
```

**可能原因**：PyTorch 2.x移除了某些API

**解决方案**：
- 查找替代API
- 或添加兼容性代码

## 长期解决方案

如果需要长期使用RTX 5090，建议：

1. **升级项目代码**：
   - 升级到mmcv >= 2.0.0
   - 修改不兼容的API调用
   - 测试所有功能

2. **或使用兼容GPU**：
   - RTX 3090/4090等支持PyTorch 1.x的GPU
   - 可以在PyTorch 1.x环境下运行

## 验证步骤

运行以下命令验证环境：

```bash
# 1. 检查GPU
python -c "import torch; print('GPU:', torch.cuda.get_device_name(0) if torch.cuda.is_available() else 'N/A')"

# 2. 检查PyTorch
python -c "import torch; print('PyTorch:', torch.__version__)"

# 3. 检查mmcv
python -c "import mmcv; print('MMCV:', mmcv.__version__)"

# 4. 测试基本操作
python -c "import torch; x = torch.randn(2, 3).cuda(); print('GPU测试:', x.shape)"
```

## 参考

- **版本兼容性说明.md** - 详细的版本兼容性文档
- **代码兼容性处理说明.md** - 代码层面的兼容性处理
- NVIDIA RTX 5090官方文档
- PyTorch CUDA兼容性文档

## 重要提示

⚠️ **实验性功能**：使用PyTorch 2.x是实验性的，可能不稳定。

⚠️ **需要测试**：建议先在小的数据集上测试，确保功能正常。

⚠️ **可能的问题**：可能遇到API不兼容、性能问题或其他错误。
