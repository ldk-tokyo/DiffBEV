# DiffBEV 配置检查说明

## 已创建的符合规范的配置文件

### 1. 训练计划配置
**文件**：`configs/_base_/schedules/schedule_200k_nuscenes.py`

**配置内容**：
- ✅ 优化器：AdamW
- ✅ 学习率：2e-4（0.0002）
- ✅ 权重衰减：0.01
- ✅ 总迭代次数：200,000
- ✅ Warmup迭代次数：1,500
- ✅ 学习率策略：poly，带warmup

### 2. nuScenes训练配置
**文件**：`configs/pyva/pyva_swin_nuscenes.py`

**配置内容**：
- ✅ 数据集：nuScenesDataset
- ✅ 数据集路径：`/media/ldk950413/data0/nuscenes/`
- ✅ 输入分辨率：800×600
- ✅ Batch size：4 per GPU
- ✅ 任务：BEV语义分割（14个类别）

## 使用配置文件训练

### 训练命令

```bash
# 1. 激活环境
micromamba activate diffbev

# 2. 进入项目目录
cd /media/ldk950413/data0/DiffBEV

# 3. 开始训练（使用符合规范的配置）
python tools/train.py configs/pyva/pyva_swin_nuscenes.py \
    --work-dir work_dirs/pyva_swin_nuscenes \
    --gpu-ids 0
```

## 待确认的配置项

### 1. 损失函数实现

**规范要求**：
- `Lseg = Lwce + 10*Ldepth + 1*Ldiff`

**当前状态**：
- 需要检查当前的损失函数实现是否符合此规范
- 可能需要修改或扩展损失函数以支持：
  - Lwce（加权交叉熵损失）
  - Ldepth（深度损失，权重10）
  - Ldiff（扩散模型损失，权重1）

### 2. DiffBEV关键结构

**规范要求**：
- 支持FO-BEV、FS-BEV、sum条件
- 支持Concat/Add/Cross-Attention融合
- 支持Conv或Self-Attention的xt编码

**当前状态**：
- 当前代码主要是PYVA实现
- 需要确认是否已有DiffBEV扩散模型的实现
- 如果没有，需要根据规范实现DiffBEV的扩散模型组件

### 3. 3D检测任务

**规范要求**：
- 需要支持3D目标检测任务
- 评估指标：NDS、mAP、ATE、ASE、AOE、AVE、AAE

**当前状态**：
- 当前配置主要针对BEV语义分割
- 需要添加3D检测相关的head和评估代码

## 下一步工作

1. **验证损失函数**：
   - 检查 `mmseg/models/losses/` 中的损失函数实现
   - 确认是否符合 `Lseg = Lwce + 10*Ldepth + 1*Ldiff` 的规范

2. **检查DiffBEV实现**：
   - 搜索代码中是否有扩散模型相关的实现
   - 如果没有，需要根据论文实现DiffBEV的扩散模型组件

3. **添加3D检测支持**：
   - 如果需要进行3D检测任务，需要添加相应的检测head
   - 实现NDS、mAP等检测指标的评估代码

4. **数据集验证**：
   - 确认nuScenes v1.0-trainval数据集已正确准备
   - 验证数据路径和格式是否正确

## 配置文件验证清单

在开始训练前，请确认：

- [ ] 已激活 `diffbev` 环境
- [ ] 数据集路径正确：`/media/ldk950413/data0/nuscenes/`
- [ ] 预训练权重路径已更新
- [ ] GPU内存足够（batch_size=4, 分辨率800×600）
- [ ] 配置文件路径正确：`configs/pyva/pyva_swin_nuscenes.py`

## 注意事项

1. **严格遵循规范**：所有配置必须严格按照 `复现规范.md` 中的要求
2. **版本确认**：确保使用nuScenes v1.0完整数据集（非mini版本）
3. **损失函数权重**：确保Ldepth权重=10，Ldiff权重=1
4. **评估指标**：需要同时记录BEV分割（mIoU）和3D检测（NDS、mAP等）指标
