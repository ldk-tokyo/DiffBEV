# nuScenes 数据组织完成说明

## ✅ 数据组织成功完成

### 统计信息

- **训练场景数**: 698
- **验证场景数**: 148
- **训练图像/标注对数**: 168,048
- **验证图像/标注对数**: 35,886
- **缺失文件数**: 0

### 目录结构

```
/media/ldk950413/data0/nuScenes/
├── img_dir/
│   ├── train/          ✓ (168,048 个图像文件)
│   └── val/            ✓ (35,886 个图像文件)
├── ann_bev_dir/
│   ├── train/          ✓ (168,048 个标注文件)
│   └── val/            ✓ (35,886 个标注文件)
├── samples/            ✓ (nuScenes原始数据)
├── sweeps/             ✓ (nuScenes原始数据)
├── v1.0-trainval/      ✓ (nuScenes元数据)
├── maps/
│   └── expansion/      ✓ (地图扩展JSON文件)
└── calib.json          ✓ (相机标定文件)
```

## 数据组织脚本

脚本位置: `scripts/organize_nuscenes_data.py`

**功能**:
1. 从 `make_nuscenes_labels.py` 生成的 `map-labels-v1.2/` 目录读取BEV标注
2. 从 nuScenes 原始数据中提取对应的相机图像
3. 根据 `TRAIN_SCENES` 和 `VAL_SCENES` 划分，将数据组织到：
   - `img_dir/train` 和 `img_dir/val` (图像)
   - `ann_bev_dir/train` 和 `ann_bev_dir/val` (标注)

**使用方法**:
```bash
cd /media/ldk950413/data0/DiffBEV
python scripts/organize_nuscenes_data.py
```

**参数**:
- `--dataroot`: nuScenes数据集根目录 (默认: `/media/ldk950413/data0/nuScenes`)
- `--label-root`: BEV标注目录 (默认: `/media/ldk950413/data0/nuScenes/nuscenes/map-labels-v1.2`)
- `--output-root`: 输出根目录 (默认: `dataroot`)

## 数据准备完整流程

### 步骤1: 生成BEV标注
```bash
cd /media/ldk950413/data0/DiffBEV
bash prepare_nuscenes_bev_data.sh
```
生成标注文件到 `nuscenes/map-labels-v1.2/` (约需数小时)

### 步骤2: 组织数据到目录结构
```bash
cd /media/ldk950413/data0/DiffBEV
python scripts/organize_nuscenes_data.py
```
组织图像和标注到 `img_dir` 和 `ann_bev_dir` (约需1-2分钟)

## 下一步：开始训练

数据准备完成后，可以开始训练：

### Baseline训练
```bash
cd /media/ldk950413/data0/DiffBEV
bash run_baseline_nuscenes.sh
```

### 或直接使用训练命令
```bash
cd /media/ldk950413/data0/DiffBEV
python tools/train.py configs/baseline/lss_swin_nuscenes.py \
    --work-dir runs/baseline \
    --gpu-ids 0
```

## 验证数据准备

检查数据是否准备完整：
```bash
# 检查文件数量
echo "训练图像: $(ls -1 /media/ldk950413/data0/nuScenes/img_dir/train/*.png | wc -l)"
echo "训练标注: $(ls -1 /media/ldk950413/data0/nuScenes/ann_bev_dir/train/*.png | wc -l)"
echo "验证图像: $(ls -1 /media/ldk950413/data0/nuScenes/img_dir/val/*.png | wc -l)"
echo "验证标注: $(ls -1 /media/ldk950413/data0/nuScenes/ann_bev_dir/val/*.png | wc -l)"

# 检查文件是否匹配（图像和标注文件名应该一致）
diff <(ls /media/ldk950413/data0/nuScenes/img_dir/train/*.png | xargs -n1 basename | sort) \
     <(ls /media/ldk950413/data0/nuScenes/ann_bev_dir/train/*.png | xargs -n1 basename | sort)
```

## 注意事项

1. **文件命名**: 图像和标注文件使用相同的文件名（`<token>.png`），确保一一对应
2. **数据划分**: 使用 `mono-semantic-maps/src/data/nuscenes/splits.py` 中定义的 `TRAIN_SCENES` 和 `VAL_SCENES`
3. **磁盘空间**: 图像和标注文件会占用大量磁盘空间，确保有足够的存储空间
4. **数据完整性**: 如果数据准备过程中断，脚本会跳过已存在的文件，可以安全地重新运行
