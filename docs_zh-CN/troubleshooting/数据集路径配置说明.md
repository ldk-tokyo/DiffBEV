# nuScenes数据集路径配置说明

## 统一路径配置

所有nuScenes数据集路径已统一配置为：
```
/media/ldk950413/data0/nuscenes
```

## 修改的文件

### 1. 配置文件

#### `configs/_base_/datasets/nuscene.py`
- **修改内容**：统一 `data_root` 路径为 `/media/ldk950413/data0/nuscenes`
- **说明**：这是nuScenes数据集的基础配置文件

#### `configs/pyva/pyva_swin_nuscenes.py`
- **修改内容**：统一所有数据集的 `data_root` 路径
- **影响范围**：
  - `data.train.data_root`
  - `data.val.data_root`
  - `data.test.data_root`

### 2. 训练脚本

#### `tools/train.py`
- **新增功能**：`check_nuscenes_dataset_path()` 函数
- **功能说明**：
  1. 检查数据集根目录是否存在
  2. 验证配置文件中的路径是否与统一路径一致
  3. 检查关键的nuScenes目录：
     - `samples/` - nuScenes原始samples数据
     - `sweeps/` - nuScenes原始sweeps数据
     - `v1.0-trainval/` - nuScenes v1.0-trainval版本目录
  4. 检查BEV处理后的数据目录（给出警告，不强制）
  5. 检查 `calib.json` 文件（给出警告，不强制）

## 路径检查机制

### 检查时机
在训练脚本启动阶段（配置加载后、模型构建前）自动检查。

### 检查逻辑

1. **关键目录检查（必须存在，否则报错退出）**：
   - `/media/ldk950413/data0/nuscenes/samples/`
   - `/media/ldk950413/data0/nuscenes/sweeps/`
   - `/media/ldk950413/data0/nuscenes/v1.0-trainval/`

2. **BEV数据目录检查（警告，不强制）**：
   - `/media/ldk950413/data0/nuscenes/img_dir/train/`
   - `/media/ldk950413/data0/nuscenes/ann_bev_dir/train/`
   - `/media/ldk950413/data0/nuscenes/img_dir/val/`
   - `/media/ldk950413/data0/nuscenes/ann_bev_dir/val/`

3. **配置文件检查**：
   - 如果配置文件中的 `data_root` 与统一路径不一致，会自动更新为统一路径

### 错误处理

- **关键目录缺失**：抛出 `AssertionError`，程序退出
- **其他目录/文件缺失**：输出警告信息，程序继续执行

## 数据集目录结构要求

```
/media/ldk950413/data0/nuscenes/
├── samples/              # 必须存在 - nuScenes原始samples数据
├── sweeps/               # 必须存在 - nuScenes原始sweeps数据
├── v1.0-trainval/        # 必须存在 - nuScenes v1.0-trainval版本目录
├── img_dir/              # BEV处理后的图像目录（可选）
│   ├── train/
│   └── val/
├── ann_bev_dir/          # BEV处理后的标注目录（可选）
│   ├── train/
│   ├── val/
│   ├── train_depth/
│   └── val_depth/
└── calib.json            # 相机标定文件（可选）
```

## 使用示例

### 启动训练时的路径检查

```bash
micromamba activate diffbev
cd /media/ldk950413/data0/DiffBEV
python tools/train.py configs/pyva/pyva_swin_nuscenes.py --work-dir work_dirs/test
```

**正常情况下的输出**：
```
================================================================================
nuScenes数据集路径检查通过
================================================================================
数据集根目录: /media/ldk950413/data0/nuscenes

存在的关键目录:
  ✓ samples: /media/ldk950413/data0/nuscenes/samples
  ✓ sweeps: /media/ldk950413/data0/nuscenes/sweeps
  ✓ v1.0-trainval: /media/ldk950413/data0/nuscenes/v1.0-trainval
================================================================================
```

**关键目录缺失时的输出**：
```
================================================================================
错误: nuScenes数据集关键目录缺失！
================================================================================
数据集根目录: /media/ldk950413/data0/nuscenes

缺失的关键目录:
  - samples: /media/ldk950413/data0/nuscenes/samples
  - sweeps: /media/ldk950413/data0/nuscenes/sweeps

请确保nuScenes v1.0-trainval数据集已正确下载并解压。
================================================================================
AssertionError: ...
```

## 注意事项

1. **路径统一**：所有配置文件中已统一使用 `/media/ldk950413/data0/nuscenes`，不要手动修改为其他路径

2. **自动修正**：如果配置文件中的路径不一致，训练脚本会自动修正为统一路径

3. **关键目录**：`samples`、`sweeps`、`v1.0-trainval` 是nuScenes原始数据的关键目录，必须存在

4. **BEV数据**：BEV处理后的数据（`img_dir`、`ann_bev_dir`）如果缺失会在训练时自动处理或报错，不会在启动时强制检查

5. **环境要求**：确保在 `diffbev` 环境中运行

## 验证路径配置

可以通过以下命令验证路径是否正确：

```bash
# 检查关键目录
ls -d /media/ldk950413/data0/nuscenes/samples
ls -d /media/ldk950413/data0/nuscenes/sweeps
ls -d /media/ldk950413/data0/nuscenes/v1.0-trainval

# 检查BEV数据目录（如果已处理）
ls -d /media/ldk950413/data0/nuscenes/img_dir
ls -d /media/ldk950413/data0/nuscenes/ann_bev_dir
```

## 修改记录

- **2024-XX-XX**：统一nuScenes数据集路径为 `/media/ldk950413/data0/nuscenes`
- **2024-XX-XX**：添加训练启动阶段的路径检查功能
