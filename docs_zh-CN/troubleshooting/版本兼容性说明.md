# DiffBEV 版本兼容性说明

## ⚠️ 重要警告

本项目使用的OpenMMLab版本较旧，**不支持PyTorch 2.x版本**。

## 当前版本要求

### 已测试的版本组合

| 组件 | 版本要求 | 说明 |
|------|---------|------|
| Python | 3.7 / 3.8 | 推荐使用Python 3.7或3.8 |
| PyTorch | **1.9.1** | **不支持PyTorch 2.x** |
| torchvision | 0.10.1 | 与PyTorch 1.9.1对应 |
| mmcv-full | 1.3.13 - 1.4.0 | **仅支持PyTorch 1.x** |
| MMSegmentation | 0.18.0 | 基于此项目的版本 |
| CUDA | 11.1 | 推荐CUDA 11.1 |

### 版本兼容性矩阵

| MMSegmentation | MMCV版本 | PyTorch版本 | CUDA版本 |
|:--------------:|:--------:|:-----------:|:--------:|
| 0.18.0 | >=1.3.13, <1.4.0 | 1.x (推荐1.9.1) | 11.1 |
| 0.18.0 | >=1.3.13, <1.4.0 | ❌ 不支持2.x | ❌ 不支持 |

## 版本检查

### 自动检查

训练脚本会在启动时自动检查版本兼容性：

- 如果检测到PyTorch 2.x，会显示警告并提示降级
- 如果检测到不兼容的mmcv版本，会报错退出

### 手动检查

```bash
# 检查PyTorch版本
python -c "import torch; print(f'PyTorch版本: {torch.__version__}')"

# 检查mmcv版本
python -c "import mmcv; print(f'MMCV版本: {mmcv.__version__}')"

# 检查mmseg版本
python -c "import mmseg; print(f'MMSeg版本: {mmseg.__version__}')"
```

## PyTorch 2.5 兼容性问题

### 问题描述

- **PyTorch 2.5** 是2024年发布的新版本
- **mmcv-full 1.3.x** 仅支持 PyTorch 1.x（最高支持到PyTorch 1.12）
- 如果使用PyTorch 2.5，会出现以下问题：
  1. mmcv-full无法正确编译
  2. 运行时可能出现API不兼容错误
  3. CUDA操作可能失败

### 解决方案

#### 方案1：使用推荐的PyTorch 1.9.1（推荐）

```bash
# 卸载当前的PyTorch
pip uninstall torch torchvision

# 安装PyTorch 1.9.1 (CUDA 11.1)
conda install pytorch==1.9.1 torchvision==0.10.1 cudatoolkit=11.1 -c pytorch
# 或者使用pip
pip install torch==1.9.1 torchvision==0.10.1 -f https://download.pytorch.org/whl/cu111/torch_stable.html
```

#### 方案2：检查并降级PyTorch版本

如果当前环境已安装PyTorch 2.x：

```bash
# 1. 检查当前版本
python -c "import torch; print(torch.__version__)"

# 2. 如果版本>=2.0，需要降级
pip uninstall torch torchvision
pip install torch==1.9.1 torchvision==0.10.1

# 3. 重新安装mmcv-full
pip uninstall mmcv-full
pip install mmcv-full==1.3.15 -f https://download.openmmlab.com/mmcv/dist/cu111/torch1.9.1/index.html
```

## 环境配置示例

### 使用conda/micromamba创建环境

```bash
# 创建环境
conda create -n diffbev python=3.7 -y
conda activate diffbev

# 安装PyTorch 1.9.1
conda install pytorch==1.9.1 torchvision==0.10.1 cudatoolkit=11.1 -c pytorch

# 安装mmcv-full
pip install mmcv-full==1.3.15 -f https://download.openmmlab.com/mmcv/dist/cu111/torch1.9.1/index.html

# 安装项目依赖
cd /media/ldk950413/data0/DiffBEV
pip install -v -e .
```

### 使用pip创建环境

```bash
# 创建虚拟环境
python3.7 -m venv diffbev_env
source diffbev_env/bin/activate  # Linux/Mac
# 或
diffbev_env\Scripts\activate  # Windows

# 安装PyTorch 1.9.1
pip install torch==1.9.1 torchvision==0.10.1 -f https://download.pytorch.org/whl/cu111/torch_stable.html

# 安装mmcv-full
pip install mmcv-full==1.3.15 -f https://download.openmmlab.com/mmcv/dist/cu111/torch1.9.1/index.html

# 安装项目依赖
cd /media/ldk950413/data0/DiffBEV
pip install -v -e .
```

## 版本升级路径（不推荐）

**注意**：如果要使用PyTorch 2.x，需要：

1. **升级mmcv**：需要使用mmcv >= 2.0.0，但本项目基于mmcv 1.3.x开发
2. **升级mmsegmentation**：需要使用mmsegmentation >= 1.0.0
3. **修改代码**：大量API已变更，需要重写部分代码
4. **风险**：可能破坏原有功能，复现结果可能不同

**建议**：除非必要，否则保持使用PyTorch 1.9.1以确保稳定性和复现性。

## 常见问题

### Q1: 我已经安装了PyTorch 2.5，怎么办？

A: 需要降级到PyTorch 1.9.1。参考"解决方案"部分的步骤。

### Q2: 我可以使用PyTorch 1.12吗？

A: mmcv-full 1.3.x理论上支持PyTorch 1.12，但建议使用1.9.1以确保稳定性。

### Q3: 为什么不能升级到新版本？

A: 这是一个基于旧版OpenMMLab框架的项目，升级需要大量代码修改，可能影响复现结果。

### Q4: 如何验证版本是否正确？

A: 运行训练脚本会自动检查。也可以手动运行：
```bash
python tools/train.py configs/pyva/pyva_swin_nuscenes.py --help
```

## 版本检查脚本

创建 `check_environment.py` 用于快速检查环境：

```python
import sys
import torch
try:
    import mmcv
    mmcv_ok = True
except:
    mmcv_ok = False

try:
    import mmseg
    mmseg_ok = True
except:
    mmseg_ok = False

print("="*60)
print("环境版本检查")
print("="*60)
print(f"Python版本: {sys.version}")
print(f"PyTorch版本: {torch.__version__}")
if mmcv_ok:
    print(f"MMCV版本: {mmcv.__version__}")
else:
    print("MMCV: 未安装")
if mmseg_ok:
    print(f"MMSeg版本: {mmseg.__version__}")
else:
    print("MMSeg: 未安装")

# 检查兼容性
pytorch_version = torch.__version__
pytorch_major = int(pytorch_version.split('.')[0])

print("\n" + "="*60)
print("兼容性检查")
print("="*60)
if pytorch_major >= 2:
    print("❌ 警告: PyTorch版本 >= 2.0，不兼容！")
    print("   请降级到PyTorch 1.9.1")
    sys.exit(1)
else:
    print("✓ PyTorch版本兼容")

if mmcv_ok:
    mmcv_version = mmcv.__version__
    mmcv_major = int(mmcv_version.split('.')[0])
    mmcv_minor = int(mmcv_version.split('.')[1])
    if mmcv_major == 1 and 3 <= mmcv_minor < 4:
        print("✓ MMCV版本兼容")
    else:
        print(f"⚠ MMCV版本 {mmcv_version} 可能不兼容，建议使用1.3.13-1.4.0")

print("="*60)
```
