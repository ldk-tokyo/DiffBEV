# nuScenes 数据准备兼容性修复说明

## 问题描述

在运行 `mono-semantic-maps/scripts/make_nuscenes_labels.py` 时遇到以下兼容性问题：

1. **shapely 2.0+ 兼容性问题**: `STRtree.query()` 返回索引而非几何对象
2. **NumPy 弃用警告**: `np.bool` 已被弃用
3. **MultiPolygon 迭代问题**: shapely 2.0+ 中 `MultiPolygon` 不能直接迭代

## 修复内容

### 1. 修复 STRtree.query() 兼容性

**文件**: `mono-semantic-maps/src/data/nuscenes/utils.py`

**问题**: 在 shapely 2.0+ 中，`STRtree.query()` 返回索引数组（`numpy.int64`），而不是几何对象本身。

**修复**:
```python
# 修复前
for polygon in polygons.query(map_patch):
    polygon = polygon.intersection(map_patch)
    # ...

# 修复后
query_indices = polygons.query(map_patch)

# 处理 shapely 2.0+ (返回索引) 和 1.x (返回几何对象)
if len(query_indices) > 0 and isinstance(query_indices[0], (int, np.integer)):
    # Shapely 2.0+: 通过 tree.geometries 访问几何对象
    for idx in query_indices:
        polygon = polygons.geometries[idx]
        polygon = polygon.intersection(map_patch)
        # ...
else:
    # Shapely 1.x: 直接使用返回的几何对象
    for polygon in query_indices:
        polygon = polygon.intersection(map_patch)
        # ...
```

### 2. 修复 np.bool 弃用问题

**文件**: `mono-semantic-maps/src/data/nuscenes/utils.py`

**问题**: NumPy 1.20+ 中 `np.bool` 已被弃用，需要使用 `bool` 或 `np.bool_`。

**修复**:
```python
# 修复前
return mask.astype(np.bool)
return masks.astype(np.bool)

# 修复后
return mask.astype(bool)
return masks.astype(bool)
```

### 3. 修复 MultiPolygon 迭代问题

**文件**: `mono-semantic-maps/src/data/nuscenes/utils.py`

**问题**: 在 shapely 2.0+ 中，`MultiPolygon` 对象不能直接迭代，需要使用 `.geoms` 属性。

**修复**:
```python
# 修复前
else:
    for poly in polygon:
        render_shapely_polygon(mask, poly, extents, resolution)

# 修复后
else:
    # 在 shapely 2.0+ 中，使用 .geoms 属性访问子几何对象
    if hasattr(polygon, 'geoms'):
        for poly in polygon.geoms:
            render_shapely_polygon(mask, poly, extents, resolution)
    else:
        # 兼容旧版本 shapely
        try:
            for poly in polygon:
                render_shapely_polygon(mask, poly, extents, resolution)
        except (TypeError, AttributeError):
            pass
```

## 验证

运行数据准备脚本验证修复：

```bash
cd /media/ldk950413/data0/DiffBEV/mono-semantic-maps
export DATA_ROOT=/media/ldk950413/data0
export PROCESSED_ROOT=/media/ldk950413/data0/nuScenes
python scripts/make_nuscenes_labels.py
```

脚本现在可以正常运行，处理速度约为 1.7-2.0 秒/场景。

## 环境信息

- **shapely 版本**: 2.0.7
- **NumPy 版本**: 需要检查（可能 >= 1.20）
- **Python 版本**: 3.8

## 相关文件

- `mono-semantic-maps/src/data/nuscenes/utils.py` - 主要修复文件
- `mono-semantic-maps/scripts/make_nuscenes_labels.py` - 数据准备脚本

## 注意事项

1. 这些修复保持了向后兼容性，同时支持 shapely 1.x 和 2.x
2. 如果使用其他版本的 shapely，可能需要进一步调整
3. 数据准备过程可能需要较长时间（约 850 个场景，每个场景约 1.7-2.0 秒）
