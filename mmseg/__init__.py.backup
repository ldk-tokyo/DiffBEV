# Copyright (c) OpenMMLab. All rights reserved.
import warnings

import mmcv
from packaging.version import parse

from .version import __version__, version_info

MMCV_MIN = '1.3.13'
MMCV_MAX = '1.4.0'

# 在导入时检查PyTorch版本兼容性
def _check_pytorch_version():
    """检查PyTorch版本是否兼容（在模块导入时自动执行）"""
    import os
    
    # 检查是否允许PyTorch 2.x（用于新GPU如RTX 5090）
    allow_pytorch2 = os.environ.get('DIFFBEV_ALLOW_PYTORCH2', '0') == '1'
    
    try:
        import torch
        pytorch_version = torch.__version__
        # 处理版本号格式，如 "1.9.1+cu111" 或 "2.5.0"
        version_parts = pytorch_version.split('+')[0].split('.')
        pytorch_major = int(version_parts[0])
        
        if pytorch_major >= 2:
            # 检查是否是新GPU
            from .utils.compat import check_gpu_compatibility
            is_new_gpu, gpu_name, gpu_arch = check_gpu_compatibility()
            
            if allow_pytorch2 and is_new_gpu:
                # 允许继续，但会显示警告
                warning_msg = (
                    f"\n{'='*80}\n"
                    f"⚠️  警告: 检测到新架构GPU ({gpu_name}) 和 PyTorch 2.x\n"
                    f"{'='*80}\n"
                    f"已设置 DIFFBEV_ALLOW_PYTORCH2=1，允许继续执行\n"
                    f"但请注意：mmcv-full 1.3.x可能与PyTorch 2.x不兼容\n"
                    f"可能遇到运行时错误，需要相应的代码修改\n"
                    f"{'='*80}\n"
                )
                warnings.warn(warning_msg)
                return  # 允许继续
            
            # 如果是新GPU但未设置环境变量，给出友好提示
            if is_new_gpu:
                error_msg = (
                    f"\n{'='*80}\n"
                    f"检测到新架构GPU和PyTorch 2.x\n"
                    f"{'='*80}\n"
                    f"GPU: {gpu_name}\n"
                    f"PyTorch版本: {pytorch_version}\n\n"
                    f"新架构GPU（如RTX 5090）可能需要PyTorch 2.x，但本项目默认使用PyTorch 1.x\n\n"
                    f"解决方案:\n"
                    f"1. 允许PyTorch 2.x（实验性，可能有兼容性问题）:\n"
                    f"   export DIFFBEV_ALLOW_PYTORCH2=1\n"
                    f"   然后重新运行\n\n"
                    f"2. 参考文档: 版本兼容性说明.md\n"
                    f"{'='*80}\n"
                )
            else:
                error_msg = (
                    f"\n{'='*80}\n"
                    f"错误: PyTorch版本不兼容！\n"
                    f"{'='*80}\n"
                    f"当前PyTorch版本: {pytorch_version}\n"
                    f"要求的PyTorch版本: 1.x (推荐1.9.1)\n\n"
                    f"原因: mmcv-full 1.3.x仅支持PyTorch 1.x\n\n"
                    f"解决方案:\n"
                    f"  1. 降级PyTorch: conda install pytorch==1.9.1 torchvision==0.10.1 cudatoolkit=11.1 -c pytorch\n"
                    f"  2. 参考文档: 版本兼容性说明.md\n"
                    f"{'='*80}\n"
                )
            raise RuntimeError(error_msg)
    except ImportError:
        # PyTorch可能还未安装，这里不报错，让后续代码处理
        pass

# 在模块导入时执行检查（尽早发现不兼容问题）
_check_pytorch_version()


def digit_version(version_str: str, length: int = 4):
    """Convert a version string into a tuple of integers.

    This method is usually used for comparing two versions. For pre-release
    versions: alpha < beta < rc.

    Args:
        version_str (str): The version string.
        length (int): The maximum number of version levels. Default: 4.

    Returns:
        tuple[int]: The version info in digits (integers).
    """
    version = parse(version_str)
    assert version.release, f'failed to parse version {version_str}'
    release = list(version.release)
    release = release[:length]
    if len(release) < length:
        release = release + [0] * (length - len(release))
    if version.is_prerelease:
        mapping = {'a': -3, 'b': -2, 'rc': -1}
        val = -4
        # version.pre can be None
        if version.pre:
            if version.pre[0] not in mapping:
                warnings.warn(f'unknown prerelease version {version.pre[0]}, '
                              'version checking may go wrong')
            else:
                val = mapping[version.pre[0]]
            release.extend([val, version.pre[-1]])
        else:
            release.extend([val, 0])

    elif version.is_postrelease:
        release.extend([1, version.post])
    else:
        release.extend([0, 0])
    return tuple(release)


mmcv_min_version = digit_version(MMCV_MIN)
mmcv_max_version = digit_version(MMCV_MAX)
mmcv_version = digit_version(mmcv.__version__)


assert (mmcv_min_version <= mmcv_version <= mmcv_max_version), \
    f'MMCV=={mmcv.__version__} is used but incompatible. ' \
    f'Please install mmcv>={mmcv_min_version}, <={mmcv_max_version}.'

__all__ = ['__version__', 'version_info', 'digit_version']
